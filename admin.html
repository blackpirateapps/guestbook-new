<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guestbook Admin</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 20px auto; padding: 0 10px; }
        .login-box { border: 1px solid #ccc; padding: 20px; max-width: 300px; margin: 50px auto; }
        
        /* Collapsible Styling */
        details.entry-details { 
            border: 1px solid #ddd; 
            margin-bottom: 5px; 
            background: #fff;
        }
        details.entry-details summary {
            padding: 10px;
            background: #f0f0f0;
            cursor: pointer;
            list-style: none; /* Hide default triangle in some browsers */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details.entry-details summary:hover { background: #e0e0e0; }
        details.entry-details[open] summary { border-bottom: 1px solid #ddd; }
        
        /* Custom arrow for summary */
        details.entry-details summary::after { content: '+'; font-weight: bold; }
        details.entry-details[open] summary::after { content: '-'; }

        .entry-content { padding: 15px; }

        .pagination { margin: 20px 0; text-align: center;}
        button { cursor: pointer; padding: 5px 10px; }
        input, textarea, select { width: 100%; box-sizing: border-box; margin-bottom: 8px; padding: 5px; }
        .hidden { display: none; }
        .actions { margin-top: 10px; display: flex; gap: 10px;}
        .danger { background-color: #ffcccc; border: 1px solid red; color: darkred; }
        
        .row { display: flex; gap: 10px; align-items: center;}
        .col { flex: 1; }
        label { font-size: 0.8em; color: #666; display: block; margin-bottom: 2px;}
    </style>
</head>
<body>

    <div id="login-screen" class="login-box">
        <h3>Admin Access</h3>
        <input type="password" id="secret-input" placeholder="Enter ADMIN_SECRET">
        <button onclick="login()">Enter</button>
    </div>

    <div id="dashboard" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h1>Admin Dashboard</h1>
            <button onclick="logout()">Logout</button>
        </div>

        <details style="border: 2px solid #333; margin-bottom: 20px;">
            <summary style="padding: 10px; background: #333; color: white; cursor: pointer;"><strong>+ Add New / Import Entry</strong></summary>
            <div style="padding: 15px; border: 1px solid #333; border-top: none;">
                <label>Name</label>
                <input type="text" id="new-name">
                
                <label>Website</label>
                <input type="text" id="new-website">
                
                <label>Created At (ISO String)</label>
                <div class="row">
                    <div class="col"><input type="text" id="new-date-raw" placeholder="YYYY-MM-DDTHH:MM:SSZ"></div>
                    <div class="col" style="flex: 0 0 40px; text-align: center;">OR</div>
                    <div class="col"><input type="datetime-local" onchange="syncDate(this, 'new-date-raw')"></div>
                </div>

                <label>Message</label>
                <textarea id="new-message" rows="3"></textarea>
                
                <button onclick="addEntry()">Save Entry</button>
            </div>
        </details>

        <hr>

        <div id="entries-container">Loading...</div>

        <div class="pagination">
            <button onclick="changePage(-1)">Previous</button>
            <span id="page-indicator" style="margin: 0 15px;">Page 1</span>
            <button onclick="changePage(1)">Next</button>
        </div>
    </div>

    <script>
        let SECRET = localStorage.getItem('admin_secret') || '';
        let CURRENT_PAGE = 1;

        if (SECRET) showDashboard();

        function login() {
            const input = document.getElementById('secret-input').value;
            if (!input) return alert('Enter secret');
            SECRET = input;
            localStorage.setItem('admin_secret', SECRET);
            showDashboard();
        }

        function logout() {
            localStorage.removeItem('admin_secret');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadEntries();
        }

        // Helper: Convert local datetime picker value to ISO string for the raw input
        function syncDate(picker, rawInputId) {
            if(picker.value) {
                // Create date object from picker value
                const d = new Date(picker.value);
                // Convert to ISO string for DB
                document.getElementById(rawInputId).value = d.toISOString();
            }
        }

        async function api(action, data = {}) {
            const res = await fetch('/api/admin', {
                method: 'POST',
                body: JSON.stringify({ action, secret: SECRET, ...data })
            });
            const json = await res.json();
            if (res.status === 401) {
                alert('Invalid Secret');
                logout();
                return null;
            }
            if (json.error) {
                alert(json.error);
                return null;
            }
            return json;
        }

        async function loadEntries() {
            const data = await api('list', { page: CURRENT_PAGE });
            if (!data) return;

            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            document.getElementById('page-indicator').innerText = `Page ${data.page} (Total: ${data.total})`;

            data.rows.forEach(row => {
                const details = document.createElement('details');
                details.className = 'entry-details';
                
                // Format date for display in summary
                const dateDisplay = new Date(row.created_at).toLocaleString();
                
                details.innerHTML = `
                    <summary>
                        <span><strong>#${row.id}</strong> ${row.name}</span>
                        <span style="font-size:0.8em; color:#666;">${dateDisplay}</span>
                    </summary>
                    <div class="entry-content">
                        <label>Name</label>
                        <input type="text" value="${row.name}" id="name-${row.id}">
                        
                        <label>Website</label>
                        <input type="text" value="${row.website || ''}" id="site-${row.id}">
                        
                        <label>Message</label>
                        <textarea rows="4" id="msg-${row.id}">${row.message}</textarea>

                        <div class="actions">
                            <button onclick="updateEntry(${row.id})">Save Changes</button>
                            <button class="danger" onclick="deleteEntry(${row.id})">Delete Entry</button>
                        </div>
                    </div>
                `;
                container.appendChild(details);
            });
        }

        async function addEntry() {
            const name = document.getElementById('new-name').value;
            const website = document.getElementById('new-website').value;
            const message = document.getElementById('new-message').value;
            const created_at = document.getElementById('new-date-raw').value;

            if (!name || !message) return alert('Name and Message required');

            const res = await api('create', { name, website, message, created_at });
            if (res) {
                alert('Added!');
                // clear inputs
                document.getElementById('new-name').value = '';
                document.getElementById('new-website').value = '';
                document.getElementById('new-message').value = '';
                document.getElementById('new-date-raw').value = '';
                loadEntries();
            }
        }

        async function updateEntry(id) {
            const name = document.getElementById(`name-${id}`).value;
            const website = document.getElementById(`site-${id}`).value;
            const message = document.getElementById(`msg-${id}`).value;

            const res = await api('update', { id, name, website, message });
            if (res) alert('Updated successfully');
        }

        async function deleteEntry(id) {
            if(!confirm('Are you sure you want to delete this entry?')) return;
            const res = await api('delete', { id });
            if (res) loadEntries();
        }

        function changePage(dir) {
            if (dir === -1 && CURRENT_PAGE === 1) return;
            CURRENT_PAGE += dir;
            loadEntries();
        }
    </script>
</body>
</html>